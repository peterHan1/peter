<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0,user-scalable=no" name="viewport">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
    <script src="js/jquery-1.8.3.min.js"></script>
    <link rel="stylesheet" href="css/index.css">
</head>

<body>
	<div class="calendar_box">

	    <div class="calendar">
	    	<!--left日历-->
	    	<div class="account_box fl">
		        <div class="account_title">
		        	<div class="data_top">
		            	<div class="data_top_btn data_top_btn_l fl">&lt;</div>
		            	<div class="fl data_top_datas">
		            		<span class="f_year"></span>年<span class="f_month"></span>月
		            	</div>
		            	<div class="data_top_btn data_top_btn_r fr">&gt;</div>
		        	</div>
		        </div>
		        <div class="data_table">
		            <div class="celarfix">
		                <div class="data_table_th">日</div>
		                <div class="data_table_th">一</div>
		                <div class="data_table_th">二</div>
		                <div class="data_table_th">三</div>
		                <div class="data_table_th">四</div>
		                <div class="data_table_th">五</div>
		                <div class="data_table_th">六</div>
		                <div class="clear"></div>
		            </div>
		            <div class="data_tbody clearfix"></div>
		        </div>
		        <dvi class="datas_title">
		            	<span><i class="red_dot"></i>有待回款项目</span>
		            	<span><i class="gray_dot"></i>有已回款项目</span>
		            </dvi>
		    </div>
		    <!--right回款金额-->
		    <div class="re_money_box fl">
		    	<div class="re_money_tlt">
		            <p><span class="re_money_y"></span>年<span class="re_money_m"></span>月<span class="re_money_d"></span></p>
		    	</div>
		    	<div class="re_money_cont">
		    		<div class="fl">
		    			<p class="re_money_num re_money_await">1,999.00</p>
		    			<p class="re_money_txt">待收本息(元)</p>
		    		</div>
		    		<div class="fl">
		    			<p class="re_money_num re_money_yet">5,000.00</p>
		    			<p class="re_money_txt">已收本息(元)</p>
		    		</div>
		    	</div>
		    </div>
	    </div>
	    <div class="re_money_table">
	    	<table >
	    		<thead>
	    			<tr>
	    				<th>回款时间</th>
	    				<th>项目名称</th>
	    				<th>期数</th>
	    				<th>回款类型</th>
	    				<th>回款金额(元)</th>
	    				<th>回款状态</th>
	    			</tr>
	    		</thead>
	    		<tbody class="re_money_tbody">
	    			
	    		</tbody>
	    	</table>
	    </div>		
	</div>
</body>
<script>
$(function(){	
	    //页面加载初始化年月
	    var mydate = new Date();
	    $(".f_year,.re_money_y").html( mydate.getFullYear() );
	    $(".f_month,.re_money_m").html( mydate.getMonth()+1 );
	    showDate(mydate.getFullYear(),mydate.getMonth()+1);

	    //日历上一月
	    $(".data_top_btn_l ").click(function(){
	        var mm = parseInt($(".f_month").html());
	        var yy = parseInt($(".f_year").html());
	        if( mm == 1){//返回12月
	            $(".f_year,.re_money_y").html(yy-1);
	            $(".f_month,.re_money_m").html(12);
	              $(".re_money_d").html(" ");
	            showDate(yy-1,12);
	        }else{//上一月
	            $(".f_month,.re_money_m").html(mm-1);
	              $(".re_money_d").html(" ");
	            showDate(yy,mm-1);
	        }
	    })
	    //日历下一月
	    $(".data_top_btn_r").click(function(){
	        var mm = parseInt($(".f_month").html());
	        var yy = parseInt($(".f_year").html());
	        if( mm == 12){//返回12月
	            $(".f_year,.re_money_y").html(yy+1);
	            $(".f_month,.re_money_m").html(1);
	            $(".re_money_d").html(" ");
	            showDate(yy+1,1);
	        }else{//上一月
	            $(".f_month,.re_money_m").html(mm+1);
	              $(".re_money_d").html(" ");
	            showDate(yy,mm+1);
	        }
	    })
	    //读取年月写入日历  重点算法!!!!!!!!!!!
	    function showDate(yyyy,mm){
	    	var mydate = new Date();
	        var y = mydate.getFullYear();
	        var m = mydate.getMonth()+1;
	        var dd = new Date(parseInt(yyyy),parseInt(mm), 0);   //Wed Mar 31 00:00:00 UTC+0800 2010  
	        var daysCount = dd.getDate();            //本月天数  
	        var mystr ="";//写入代码
	        var icon = "";//图标代码
	        var today = new Date().getDate(); //今天几号  21
	        var monthstart = new Date(parseInt(yyyy)+"/"+parseInt(mm)+"/1").getDay()//本月1日周几  
	        var lastMonth; //上一月天数
	        var nextMounth//下一月天数
	        if(  parseInt(mm) ==1 ){
	            lastMonth = new Date(parseInt(yyyy)-1,parseInt(12), 0).getDate();
	        }else{
	            lastMonth = new Date(parseInt(yyyy),parseInt(mm)-1, 0).getDate();
	        }
	        if( parseInt(mm) ==12 ){
	            nextMounth = new Date(parseInt(yyyy)+1,parseInt(1), 0).getDate();
	        }else{
	            nextMounth = new Date(parseInt(yyyy),parseInt(mm)+1, 0).getDate();
	        }
	        //计算上月空格数
	        for(j=monthstart;j>0;j--){
	            mystr += "<div class='data_table_td data_null data_lastMonth' style='color:#ccc;'>"+(lastMonth-j+1)+"</div>";
	        }
	        
	        //本月单元格
	         for(i=0;i<daysCount;i++){
	             //这里为一个单元格，添加内容在此
	            mystr += "<div class='data_table_td data_number'><span class='data_day'>"+(i+1)+"</span></div>"; 
	        }

	        //计算下月空格数
	        for(k=0; k<42-(daysCount+monthstart);k++ ){//表格保持等高6行42个单元格
	            mystr += "<div class='data_table_td data_null data_nextMounth' style='color:#ccc;'>"+(k+1)+"</div>";
	        }

	        //写入日历
	        $(".data_table .data_tbody").html(mystr);
	        //给今日加class
	        if( mydate.getFullYear() == yyyy){
	            if( (mydate.getMonth()+1 ) == mm){
	                var today = mydate.getDate();
	                var lastNum = $(".data_lastMonth").length;
	                $(".data_table .data_table_td").eq(today+lastNum-1).addClass("datas_on");
	            }
	        }			
	       	//给有回款的日期添加class
	       		$.ajax({
					url: 'js/time.json',
					dataType: "json",
					type: 'get',
					success:function(data){
					    $(".re_money_tbody").empty();
					    	$.each(data,function(i,item){ 
								var todays = new Date().setHours(0,0,0,0);
								var time = parseInt(item.time);
								var times =  new Date(time);
								var msec = times.getTime(); 
								if( times.getFullYear() == yyyy){
						            if( (times.getMonth()+1 ) == mm){
					            		var tr = "<tr><td>"+ getMoth(parseInt(item.time)) +"</td><td>"+item.name+"</td><td>"+item.periods+"</td><td>"+item.type+"</td><td>"+item.money+"</td><td>"+item.status+"</td></tr>";
				       			 		$(".re_money_tbody").append(tr);
						            	if(msec >= todays){
						            		var today = times.getDate();
							                var lastNum = $(".data_lastMonth").length;
							                $(".data_table .data_table_td").eq(today+lastNum-1).addClass("await_money");
						            	}else{
						            		var today = times.getDate();
							                var lastNum = $(".data_lastMonth").length;
							                $(".data_table .data_table_td").eq(today+lastNum-1).addClass("yet_money");
						            	}
						            }
						        }								
							});
							if(!$('.re_money_tbody tr').html()){
				            	var tr = "<tr><td colspan='6'>当前没有回款信息</td></tr>";
								$(".re_money_tbody").html(tr);
				            }
					}
				});

	       	function getMoth(str){  
	            var oDate = new Date(str),  
	            oYear = oDate.getFullYear(),
	            oMonth = oDate.getMonth()+1,  
	            oDay = oDate.getDate(),  
	            oTime = oYear + '-' +oMonth +'-'+ oDay;//最后拼接时间  
	            return oTime;  
	        };  
	        //绑定选择方法
	        $(".data_table .data_number").off("click");
	        $(".data_table .data_number").on("click",function(){
	        	$(".data_table .data_number").removeClass("datas_on");
	            $(this).addClass("datas_on");
	        	var thisy = $(".f_year").html();
	        	var thism = $(".f_month").html();
	        	var thisd = $(this).find('span').html();
	        	$(".re_money_d").html(thisd+'日');
//	        	console.log(thisy +'年'+ thism +'月'+ thisd +'日')
	        	
	        	var oldTime = (new Date(thisy+'-'+thism+'-'+thisd)).getTime(); //得到毫秒数  
				var newTime = new Date(oldTime); //就得到普通的时间了 
//					console.log(oldTime)
	            $(".re_money_tbody").empty();
	            //选择日期请求接口 显示回款内容
	            $.ajax({
					url: 'js/time.json',
					dataType: "json",
					type: 'get',
					success:function(data){
						$.each(data,function(i,item){
							if(item.time == oldTime){
								console.log(666);
								var tr = "<tr><td>"+ getMoth(parseInt(this.time)) +"</td><td>"+this.name+"</td><td>"+this.periods+"</td><td>"+this.type+"</td><td>"+this.money+"</td><td>"+this.status+"</td></tr>";
				       			$(".re_money_tbody").append(tr);
				       			$(".re_money_await").html(this.await);
								$(".re_money_yet").html(this.yet);
							}								
						});
						if(!$('.re_money_tbody tr').html()){
			            	var tr = "<tr><td colspan='6'>当前没有回款信息</td></tr>";
							$(".re_money_tbody").html(tr);
							$(".re_money_await").html("0.00");
							$(".re_money_yet").html("0.00");
			            }

					}
				});
	            
	       });
	    }
})
</script>
</html>